안정 해시 설계
=

수평적 규모 확장을 달성하기 위해서는 요청 혹은 데이터를 서버에 균등하게 나누는 것이 중요하다.
안정해시는 이 목표를 달성하기 위해 보편적으로 사용하는 기술이다.

해시 키 재배치 문제
-
N개의 서버가 있을 때, 이 서버들에 부하를 균등하게 나누는 보편적인 방법은 아래와 같다.
> serverIndex = hash(key) % N

이 방법은 서버 풀이 고정되어 있고 데이터 분포가 균등할 때 잘 동작한다.
하지만 서버가 추가되거나, 기존의 서버가 삭제되면 대규모 캐시 미스가 생기는 문제가 생긴다. (인덱스를 결정하는 N이 변하기 때문)

안정 해시
-
안정 해시는 해시 테이블 크기가 조정될 때, 평균적으로 오직 k(키의 갯수)/n(슬롯의 갯수)개의 키만 재배치하는 해시 기술이다.
전통적인 해시 테이블에서 슬롯의 수가 변하면 거의 대부분의 키를 재배치하는 것과 대조적이다.

어떤 키가 저장되는 서버는 해당 키의 위치로부터 시계방향으로 해시 링을 탐색하며 만나는 첫 번째 서버이다.
이렇게 되면 서버를 추가 혹은 삭제하더라도 키 가운데 일부만 재배치 하면 된다.
왜냐하면 시계 방향으로 순회할 때 만나는 첫 번째 서버가 달라지는 지점을 특정할 수 있기 때문이다.

기본 구현법의 두 가지 문제
-

기본적인 절차는 아래와 같다.

1. 서버와 키를 균등 분포 해시 함수를 사용해 해시 링에 배치한다.
2. 키의 위치에서 링을 시계 방향으로 탐색하다 만나는 최초의 서버가 키가 저장될 위치이다.

하지만 이 접근법의 아래의 두 가지 문제가 있다.

1. 서버가 추가되거나 삭제되는 상황을 감안하면 파티션(서버 사이의 해시 공간)의 크기를 균등하게 유지하는게 불가능하다.
2. 키의 균등 분포는 달성하기 어렵다.

이 문제를 해결하기 위해 가상 노드 혹은 복제라고 불리는 기법이 제안된다.

가상 노드
-
가상 노드는 실제 노드 혹은 서버를 가리키는 노드로서 하나의 서버는 링 위에 여러 개의 가상노드를 가질 수 있다.
가상 노드의 수를 늘리면 키의 분포는 점점 더 균등해진다.
가상 노드가 늘어나면 표준 편차의 값은 떨어지나, 가상 노드 데이터를 저장할 공간은 더 많이 필요해진다.




